<?xml version="1.0" encoding="utf-8"?>
<s:VGroup xmlns:fx="http://ns.adobe.com/mxml/2009"
          xmlns:s="library://ns.adobe.com/flex/spark" 
		  xmlns:components="awaybuilder.view.components.*" xmlns:controls="awaybuilder.view.components.controls.*"
		  currentState="{data.type}" xmlns:mx="library://ns.adobe.com/flex/mx" gap="0">
    <fx:Declarations>
		<s:RadioButtonGroup id="typeRadioGroup" selectedValue="{data.type}" change="typeRadioGroup_changeHandler(event)"/>
    </fx:Declarations>
	<s:states>
		<s:State name="textureType"/>
		<s:State name="colorType"/>
	</s:states>
    <fx:Script><![CDATA[
		import away3d.materials.MaterialBase;
		import away3d.materials.utils.DefaultMaterialManager;
		import away3d.textures.Texture2DBase;
		
		import awaybuilder.model.vo.scene.AssetVO;
		import awaybuilder.model.vo.scene.BitmapTextureVO;
		import awaybuilder.model.vo.scene.MaterialVO;
		import awaybuilder.view.components.controls.events.ExtendedDropDownEvent;
		
		import mx.collections.ArrayCollection;
		import mx.collections.ArrayList;
		import mx.events.ColorPickerEvent;
		
		import spark.events.IndexChangeEvent;

		[Bindable]
		private var _isDefault:Boolean = false;
		
        private var _data:MaterialVO;
		
		private var _prevSelected:ArrayCollection = new ArrayCollection; 
		[Bindable]
		public function set prevSelected( value:ArrayCollection ): void
		{
			this._prevSelected = value;
		}
		public function get prevSelected():ArrayCollection
		{
			return this._prevSelected;
		}
		
		[Bindable]
		private var _selectedTexture:BitmapTextureVO;
		
		[Bindable]
        public function get data():MaterialVO
        {
            return _data;
        }
        public function set data( value:MaterialVO ):void
        {
            if( !value ) return;
            _data = value;
			this.currentState = _data.type;
			_isDefault =  _data.linkedObject == DefaultMaterialManager.getDefaultMaterial();
            for each(var texture:BitmapTextureVO in _data.linkedTextures) 
			{
                if (texture.linkedObject == _data.texture.linkedObject) 
				{
                   _selectedTexture = texture;
                }
            }
        }
		
        private function name_changeHandler(event:Event):void 
		{
            var newValue:MaterialVO = data.clone();
            newValue.name = nameInput.text;
            dispatchEvent(new PropertyEditorEvent(PropertyEditorEvent.MATERIAL_NAME_CHANGE, newValue, true));
        }

        private function repeatBox_changeHandler(event:Event):void 
		{
            var newValue:MaterialVO = data.clone();
            newValue.repeat = repeatBox.selected;
            dispatchEvent(new PropertyEditorEvent(PropertyEditorEvent.MATERIAL_CHANGE, newValue, true));
        }

        private function dropDownList_changeHandler(event:IndexChangeEvent):void 
		{
			if( dropDownList.selectedItem ) {
				var newValue:MaterialVO = data.clone();
				newValue.texture = dropDownList.selectedItem as BitmapTextureVO;
				dispatchEvent(new PropertyEditorEvent(PropertyEditorEvent.MATERIAL_CHANGE, newValue, true));
			}
        }
		
        private function editTextureButton_clickHandler(event:MouseEvent):void 
		{
            dispatchEvent(new PropertyEditorEvent(PropertyEditorEvent.SHOW_TEXTURE_PROPERTIES, data.texture, true));
        }
		
		private function dropDownIconFunction(item:BitmapTextureVO):Object 
		{
			return item.bitmapData;
		}
		
		private function dropDownLabelFunction(item:BitmapTextureVO):Object 
		{
			return item.name.split("/").pop();
		}
		
		protected function dropDownList_addNewItemHandler(event:ExtendedDropDownEvent):void
		{
			dispatchEvent(new PropertyEditorEvent(PropertyEditorEvent.MATERIAL_ADD_NEW_TEXTURE, data, true));
		}
		
		protected function typeRadioGroup_changeHandler(event:Event):void
		{
			var newValue:MaterialVO = data.clone();
			newValue.type = typeRadioGroup.selectedValue as String;
			dispatchEvent(new PropertyEditorEvent(PropertyEditorEvent.MATERIAL_CHANGE, newValue, true));
		}
		
		protected function alphaStepper_changeHandler(event:Event):void
		{
			var newValue:MaterialVO = data.clone();
			newValue.alpha = alphaStepper.value/100;
			dispatchEvent(new PropertyEditorEvent(PropertyEditorEvent.MATERIAL_CHANGE, newValue, true));
		}
		
		protected function colorPicker_changeHandler(event:ColorPickerEvent):void
		{
			var newValue:MaterialVO = data.clone();
			newValue.color = colorPicker.selectedColor;
			dispatchEvent(new PropertyEditorEvent(PropertyEditorEvent.MATERIAL_CHANGE, newValue, true));
		}
		
		protected function editParentObjectButton_clickHandler(event:MouseEvent):void
		{
			dispatchEvent(new PropertyEditorEvent(PropertyEditorEvent.SHOW_PARENT_MESH_PROPERTIES, prevSelected.removeItemAt(prevSelected.length-1), true));
		}
		
	]]></fx:Script>

	<s:Group width="100%" top="0">
		<s:Rect left="0" right="0" top="3" bottom="3">
			<s:fill>
				<s:SolidColor color="0x111111" alpha="0.3"/>
			</s:fill>
		</s:Rect>
		<s:HGroup width="100%" verticalAlign="middle" paddingLeft="2" paddingRight="2" paddingTop="4" paddingBottom="4">
			<s:Button id="editParentObjectButton" styleName="editParentObjectButtonStyle" visible="{prevSelected.length>0}"
					  width="32" height="32" click="editParentObjectButton_clickHandler(event)"/>
			<s:Label width="100%" text="Material Properties" fontWeight="bold" fontSize="14"/>
		</s:HGroup>
	</s:Group>
	
	<s:HGroup width="100%" verticalAlign="middle" paddingLeft="6" paddingRight="6" paddingTop="6" paddingBottom="6" enabled="{!_isDefault}" horizontalAlign="center">
		<s:RadioButton label="Texture" width="100%" group="{typeRadioGroup}" value="{MaterialVO.TEXTURE}"/>
		<s:RadioButton label="Color" width="100%" group="{typeRadioGroup}" value="{MaterialVO.COLOR}"/>
	</s:HGroup>
	
    <controls:CollapsiblePanel width="100%" title="General" collapsed="false">
        <s:Form width="100%" skinClass="awaybuilder.view.skins.PropertyFormSkin">
            <s:FormItem label="Name" skinClass="awaybuilder.view.skins.PropertyFormItemSkin" width="100%">
                <s:TextInput id="nameInput" width="100%" text="{data.name}" change="name_changeHandler(event)" enabled="{!_isDefault}"/>
            </s:FormItem>
			<s:FormItem label="Alpha" skinClass="awaybuilder.view.skins.PropertyFormItemSkin" width="100%">
				<s:NumericStepper id="alphaStepper" minimum="0" maximum="100" value="{data.alpha*100}" change="alphaStepper_changeHandler(event)" enabled="{!_isDefault}"/>
			</s:FormItem>
            <s:FormItem label="Repeat" skinClass="awaybuilder.view.skins.PropertyFormItemSkin" width="100%" includeIn="textureType">
                <s:CheckBox id="repeatBox" change="repeatBox_changeHandler(event)" selected="{data.repeat}" enabled="{!_isDefault}"/>
            </s:FormItem>
        </s:Form>
    </controls:CollapsiblePanel>
    <controls:CollapsiblePanel width="100%" title="Main Texture" collapsed="false" includeIn="textureType">
        <s:HGroup width="100%" verticalAlign="middle">
            <controls:ExtendedDropDownList id="dropDownList" width="100%" skinClass="awaybuilder.view.skins.ExtendedDropDownListSkin"
										   itemRenderer="awaybuilder.view.components.propertyEditors.renderers.TextureItemRenderer"
				                            dataProvider="{data.linkedTextures}" selectedItem="{_selectedTexture}"
											labelFunction="{dropDownLabelFunction}"
											newItemLabel="Add New Texture"
											iconFunction="{dropDownIconFunction}"
				                            change="dropDownList_changeHandler(event)"
											addNewItem="dropDownList_addNewItemHandler(event)"
											enabled="{!_isDefault}"/>
			<s:Button id="editTextureButton" styleName="editSharedObjectButtonStyle"
					  width="23" height="100%" click="editTextureButton_clickHandler(event)"/>
        </s:HGroup>
    </controls:CollapsiblePanel>
	<s:Form width="100%" skinClass="awaybuilder.view.skins.PropertyFormSkin" includeIn="colorType">
		<s:FormItem label="Solid Color Fill" skinClass="awaybuilder.view.skins.PropertyFormItemSkin" width="100%">
			<mx:ColorPicker id="colorPicker" includeIn="colorType" selectedColor="{data.color}" change="colorPicker_changeHandler(event)" enabled="{!_isDefault}"/>
		</s:FormItem>
	</s:Form>
</s:VGroup>
